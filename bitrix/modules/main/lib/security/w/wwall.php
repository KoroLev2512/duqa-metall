<? namespace Bitrix\Main\Security\W;$GLOBALS['____614603098']= array(base64_decode('dGlt'.'ZQ'.'=='),base64_decode('d'.'GltZQ=='),base64_decode('anN'.'vbl9kZ'.'WNvZGU='),base64_decode(''.'YXJy'.'YXlfb'.'W'.'VyZ2U='),base64_decode('am9pbg=='),base64_decode('am9pbg=='),base64_decode('am9'.'pbg=='),base64_decode('YXJyYXlf'.'cG'.'9w'),base64_decode('YXJyYXlfc2hpZ'.'n'.'Q='),base64_decode('YXJy'.'Y'.'Xlf'.'c2hpZnQ='),base64_decode('YXJyYXlfc2hp'.'ZnQ='),base64_decode('YX'.'Jy'.'Y'.'Xlf'.'c2hpZn'.'Q='),base64_decode('Y'.'XJ'.'yYXlfbWV'.'yZ2U='),base64_decode('aX'.'N'.'fY'.'XJyYXk='),base64_decode(''.'YXJyYX'.'l'.'fbWVyZ2'.'U='),base64_decode('aW5'.'fYXJy'.'YX'.'k='),base64_decode(''.'aW'.'5fYXJyYXk'.'='),base64_decode('aW5f'.'YXJy'.'YXk='),base64_decode('aW5f'.'YX'.'JyYXk='),base64_decode('aW5fYXJyYXk='),base64_decode('dGltZQ='.'='),base64_decode('dG'.'ltZ'.'Q'.'='.'='),base64_decode('YXJyYXlfbWFw'),base64_decode('Z2'.'V0X2xvY'.'W'.'R'.'l'.'ZF9leHRl'.'bnNpb25'.'z'),base64_decode('anNvbl9lbm'.'N'.'vZGU='),base64_decode('anNv'.'bl9lbmNvZ'.'GU='),base64_decode('c'.'GhwdmVyc2l'.'vbg='.'='),base64_decode('anNvbl9l'.'bmNvZGU='),base64_decode('a'.'m9p'.'b'.'g=='));if(!function_exists(__NAMESPACE__.'\\___1178786393')){function ___1178786393($_1315952867){static $_1712310625= false; if($_1712310625 == false) $_1712310625=array('V1dBT'.'ExfTE9DS'.'w==','c2V'.'j'.'d'.'XJpdHk'.'=','REFU'.'QQ==','eyI=',''.'V1dBTExfT'.'E9DSw'.'==','c2V'.'j'.'dXJpdHk=','U0V'.'DVVJJVFlfV1dB'.'T'.'E'.'xfRV'.'hDRV'.'BUSU9O','RkFJTF9DS'.'EVDS'.'0lO'.'Rw==','Q2'.'F'.'uI'.'G5v'.'dC'.'BleG'.'VjdXR'.'l'.'IH'.'d3YWxsIHJ1b'.'GV'.'zOiA=','IF'.'R'.'y'.'Y'.'WNlOi'.'A=','UkVRVUVTV'.'F9V'.'Ukk=','a2'.'V'.'5cw==','dmFsdWVz','U0'.'VDVVJJ'.'V'.'FlfV1dBTE'.'xfTU9E'.'SUZ'.'Z','Lg==',''.'U0'.'VD'.'VVJJVFlfV1d'.'BTExfV'.'U5T'.'RVQ'.'=',''.'Lg='.'=','U0VDV'.'VJ'.'J'.'VFlfV'.'1dBT'.'ExfRVhJVA'.'==','L'.'g==','Z2xv'.'YmF'.'s','a2V5cw='.'=',''.'dmFsdWVz','Z2V'.'0',''.'Z'.'2V0','cG9zdA'.'==',''.'c'.'G9z'.'dA==','Y29va2ll','Y'.'29va2ll',''.'cmVxd'.'WVzdA==','cm'.'VxdWV'.'zdA==',''.'Z2'.'xvYm'.'Fs','Z2'.'xvYmF'.'s','bWFpbl9zZW'.'M=','V1dB'.'T'.'ExfQ'.'UNUV'.'UFMSVpFX1JVTEVT','dg==',''.'dmVy'.'c2lv'.'b'.'g==','aQ==','aXNJbnN0YWxs'.'ZWQ=','dg==','aW'.'5p','bW9k'.'dWx'.'l'.'cw==','bGljZW5zZQ'.'==','cGhw','d'.'g==','ZXh0','c'.'2VjdXJpdHk=','ZGI=',''.'dHlwZQ='.'=','ZGI=','dmVyc2lvbg==',''.'ZGI'.'=','dHlwZ'.'Q'.'='.'=','ZGI'.'=','d'.'HlwZQ'.'==','d'.'mVy'.'c2l'.'v'.'bg==','ZGI=','dm'.'Vy'.'c'.'2lvbg'.'==',''.'ZW'.'5'.'2aXJvbm1'.'lbnQ=',''.'dm1f'.'dmVyc2lvbg==','dm'.'0=','d'.'g'.'==','ZW52aXJvb'.'m1lbnQ=','dm1fdm'.'Vyc'.'2l'.'vbg='.'=','c'.'2'.'9ja'.'2'.'V0VG'.'ltZW'.'9'.'1'.'dA==','c3RyZWFt'.'VGltZW91dA==',''.'K'.'Cc'.'=','ZGF0YQ==','J'.'ywgJw==','bW9'.'kdW'.'xl','Jywg'.'Jw'.'==','bW9k'.'dWxlX3ZlcnNpb24=','Jyk'.'=',''.'LCA=','U0VDVVJJ'.'VF'.'lfV1dBTExfRVhDRVB'.'USU9'.'O','b'.'WF'.'pbg='.'=',''.'RkFJT'.'F9'.'SRUZSR'.'VNISU5H','Q2FuIG5'.'v'.'dCByZWZyZ'.'XN'.'oIHd3YWx'.'sIHJ1b'.'GVzOi'.'A=','I'.'FRyYW'.'NlOiA=',''.'ZG'.'F0YQ==',''.'e'.'yI'.'=','L'.'S0tLS1'.'CR'.'UdJ'.'T'.'i'.'BQVU'.'JMSUMgS0VZ'.'LS0t'.'L'.'S0'.'=','C'.'k1JSUJJakFOQmd'.'r'.'cWhra'.'Uc5dzBCQV'.'F'.'FRkFBT0NBUT'.'h'.'BTUlJQk'.'NnS0NBUUVBcThR'.'R'.'TBI'.'a'.'m1ISl'.'VTdFdWN'.'m'.'4wemEKUlZ'.'vTHgwMkt'.'6'.'YmZy'.'YlMv'.'UDZz'.'V2F4VHp3OFNlR1R0Y'.'lRDT3'.'JwSGk1UUY2T1J5alovWH'.'h6L0tMVT'.'FHYm9mOUNaMwo'.'0'.'e'.'j'.'dTa3F'.'V'.'dDY'.'2a'.'WJYdk9GQng0ZncvQVB'.'QUkd'.'EcX'.'RtMG5EM2Z'.'nR3N1M1'.'JlUGd'.'3Mj'.'lpOCt2bT'.'dtdEJLSlVZb'.'DRyClZwYjZzZ'.'lp'.'FV'.'DlLRWI2VDF'.'IR'.'Fl'.'tRXZj'.'MWhxL2l'.'pdX'.'l'.'4TH'.'JaWmk1U'.'TZ'.'VZmY'.'0VUV'.'2'.'VE'.'krNjh'.'zc0'.'ZSa'.'1Erb3'.'dUU'.'nkKZU9JT'.'WJG'.'aE0v'.'VVR'.'tZlZZ'.'YlRS'.'Rnkyb1'.'VRO'.'FdNemEybko1'.'U'.'2Foemkx'.'VUt'.'PM'.'Wp'.'Bal'.'hUUFJ'.'ye'.'mM3QWp1NjM5a'.'jFPM'.'Ap'.'w'.'c'.'HFmbTV'.'4Z1d'.'sRkF'.'Ka0hRVGdi'.'ZGQ1Q'.'Vdx'.'REZ'.'Ra3'.'Q5'.'SEtrWStUbmZCTEdWTXZW'.'e'.'VB'.'3VEhO'.'V1FZ'.'QXc0eHBnL3dBClp'.'3SURBU'.'UFCCi0tLS0tRU5'.'EIFBV'.'QkxJQyBLRV'.'ktLS'.'0tLQ'.'==');return base64_decode($_1712310625[$_1315952867]);}}; use Bitrix\Main\Application; use Bitrix\Main\Config\Option; use Bitrix\Main\Data\Cache; use Bitrix\Main\Loader; use Bitrix\Main\ModuleManager; use Bitrix\Main\Security\PublicKeyCipher; use Bitrix\Main\SystemException; use Bitrix\Main\Web\HttpClient; use Bitrix\Main\Web\Json; use Bitrix\Main\Security\W\Rules\Rule; use Bitrix\Main\Security\W\Rules\Results\RuleAction; use Bitrix\Main\Security\W\Rules\Results\RuleResult; use Bitrix\Main\Security\W\Rules\Results\CheckResult; use Bitrix\Main\Security\W\Rules\Results\ModifyResult; use Bitrix\Main\Type\ArrayHelper; use Bitrix\Main\Security\W\Rules\RuleRecordTable; use Bitrix\Main\License\UrlProvider; use CSecuritySystemInformation; use ReflectionExtension; class WWall{ const CACHE_RULES_TTL= 10800; protected $_1243929470= true; public function handle(){ try{  $_10607002= RuleRecordTable::getList([ 'cache' =>['ttl' => 3600* 24* 7]])->fetchAll(); if(empty($_10607002)){ return;}  $_357557435= Cache::createInstance(); $_1823287612= false; if($_357557435->initCache(static::CACHE_RULES_TTL, 'WWALL_LOCK', 'security')){ $_1250087389= $_357557435->getVars(); if($GLOBALS['____614603098'][0]()- $_1250087389> round(0+20)){  $_1171119326= Application::getConnection(); $_102860475= RuleRecordTable::getTableName(); $_1171119326->truncateTable($_102860475); RuleRecordTable::cleanCache(); $_357557435->clean(___1178786393(0), ___1178786393(1));}} elseif($_357557435->startDataCache()){  $_357557435->endDataCache($GLOBALS['____614603098'][1]()); $_1823287612= true;} foreach($_10607002 as $_1183007249){ $_1245065563= new PublicKeyCipher; $_947585872= $_1245065563->decrypt($_1183007249[___1178786393(2)], static::__1342101795()); if(!str_starts_with($_947585872, ___1178786393(3))){ continue;} $_388815447= $GLOBALS['____614603098'][2]($_947585872, true); if(!empty($_388815447)){ $_1076647405= Rule::make($_388815447); $_1488861114= $this->handleRule($_1076647405); $this->applyHandlingResults($_1488861114);}}  if($_1823287612){ $_357557435->clean(___1178786393(4), ___1178786393(5));}} catch(\Throwable $_1072362236){ $this->logEvent( ___1178786393(6), ___1178786393(7), ___1178786393(8). $_1072362236->getMessage(). ___1178786393(9). $_1072362236->getTraceAsString());}}  public function handleRule(Rule $_1076647405): array{ $_1488861114=[]; if($_1076647405->matchPath($_SERVER[___1178786393(10)])){  $_1279833749= $this->getContextElements($_1076647405->getContext()); foreach($_1279833749 as $_1637498473 => &$_1609374764){ $_1488861114= $GLOBALS['____614603098'][3]($_1488861114, $this->recursiveContextKeyHandle($_1637498473, $_1609374764,[], $_1076647405));}} return $_1488861114;}  public function applyHandlingResults(array $_1488861114){ $_1279833749= $this->getContextElements([ 'get', 'post', 'cookie', 'request', 'global']); foreach($_1488861114 as $_1979728207){ $_1609374764=& $_1279833749[$_1979728207->getContextName()]; $_1024270995= $_1979728207->getRuleResult(); $_1076647405= $_1979728207->getRule(); if($_1024270995 instanceof ModifyResult){ if($_1076647405->getProcess() === ___1178786393(11)){  static::rewriteContextKey( $_1979728207->getContextName(), $_1609374764, $_1979728207->getContextKey(), $_1024270995->getCleanValue());} elseif($_1076647405->getProcess() === ___1178786393(12)){ static::rewriteContextValue( $_1979728207->getContextName(), $_1609374764, $_1979728207->getContextKey(), $_1024270995->getCleanValue());} $this->logEvent( ___1178786393(13), $_1979728207->getContextName(), $GLOBALS['____614603098'][4](___1178786393(14), $_1979728207->getContextKey()));} elseif($_1024270995 instanceof CheckResult &&!$_1024270995->isSuccess()){ if($_1024270995->getAction() === RuleAction::UNSET){ static::unsetContextValue( $_1979728207->getContextName(), $_1609374764, $_1979728207->getContextKey(),); $this->logEvent( ___1178786393(15), $_1979728207->getContextName(), $GLOBALS['____614603098'][5](___1178786393(16), $_1979728207->getContextKey()));} elseif($_1024270995->getAction() === RuleAction::EXIT){ $this->logEvent( ___1178786393(17), $_1979728207->getContextName(), $GLOBALS['____614603098'][6](___1178786393(18), $_1979728207->getContextKey())); exit;}}}} public function disableEventLogging(){ $this->_1243929470= false;} protected function rewriteContextKey($_1637498473, &$_1609374764, $_914919398, $_256650021){ $_376476292= $_914919398;  $GLOBALS['____614603098'][7]($_376476292); $_376476292[]= $_256650021; if($_1637498473 === ___1178786393(19)){ $_1199402864= $GLOBALS['____614603098'][8]($_914919398); $GLOBALS['____614603098'][9]($_376476292); if(empty($_914919398)){ $GLOBALS[$_256650021]= $GLOBALS[$_1199402864]; unset($GLOBALS[$_1199402864]);} else{ $_1609374764=& $GLOBALS[$_1199402864]; $_508808997= ArrayHelper::getByNestedKey($_1609374764, $_914919398);  ArrayHelper::setByNestedKey($_1609374764, $_376476292, $_508808997);  ArrayHelper::unsetByNestedKey($_1609374764, $_914919398);}} else{ $_508808997= ArrayHelper::getByNestedKey($_1609374764, $_914919398);  ArrayHelper::setByNestedKey($_1609374764, $_376476292, $_508808997);  ArrayHelper::unsetByNestedKey($_1609374764, $_914919398);}} protected function rewriteContextValue($_1637498473, &$_1609374764, $_828655646, $_508808997){ if($_1637498473 === 'global'){ $_1199402864= $GLOBALS['____614603098'][10]($_828655646); if(empty($_828655646)){ $GLOBALS[$_1199402864]= $_508808997;} else{ $_1609374764=& $GLOBALS[$_1199402864]; ArrayHelper::setByNestedKey($_1609374764, $_828655646, $_508808997);}} else{  ArrayHelper::setByNestedKey($_1609374764, $_828655646, $_508808997);}} protected function unsetContextValue($_1637498473, &$_1609374764, $_828655646){ if($_1637498473 === 'global'){ $_1199402864= $GLOBALS['____614603098'][11]($_828655646); if(empty($_828655646)){ unset($GLOBALS[$_1199402864]);} else{ $_1609374764=& $GLOBALS[$_1199402864]; ArrayHelper::unsetByNestedKey($_1609374764, $_828655646);}} else{ ArrayHelper::unsetByNestedKey($_1609374764, $_828655646);}}  protected function recursiveContextKeyHandle(string $_1637498473, array &$_1609374764, array $_91873579, Rule $_1076647405): array{  $_1488861114=[]; foreach($_1609374764 as $_466311523 => $_508808997){ $_828655646= $GLOBALS['____614603098'][12]($_91873579,[$_466311523]); if($_1076647405->matchKey($_828655646)){  if($_1076647405->getProcess() === ___1178786393(20)){ $_1024270995= $_1076647405->evaluate($_466311523);} elseif($_1076647405->getProcess() === ___1178786393(21)){ $_1024270995= $_1076647405->evaluateValue($_508808997);}  if(!empty($_1024270995) && $_1024270995 instanceof RuleResult){ $_1488861114[]= new HandlingResult($_1637498473, $_828655646, $_1024270995, $_1076647405);}}  if($GLOBALS['____614603098'][13]($_508808997)){ $_1488861114= $GLOBALS['____614603098'][14]($_1488861114, $this->recursiveContextKeyHandle( $_1637498473, $_1609374764[$_466311523], $_828655646, $_1076647405));}} return $_1488861114;} protected function getContextElements(array $_906042029){ $_845383045=[]; if($GLOBALS['____614603098'][15](___1178786393(22), $_906042029, true)){ $_845383045[___1178786393(23)]= &$_GET;} if($GLOBALS['____614603098'][16](___1178786393(24), $_906042029, true)){ $_845383045[___1178786393(25)]= &$_POST;} if($GLOBALS['____614603098'][17](___1178786393(26), $_906042029, true)){ $_845383045[___1178786393(27)]= &$_COOKIE;} if($GLOBALS['____614603098'][18](___1178786393(28), $_906042029, true)){ $_845383045[___1178786393(29)]= &$_REQUEST;} if($GLOBALS['____614603098'][19](___1178786393(30), $_906042029, true)){ $_845383045[___1178786393(31)]= $GLOBALS;} return $_845383045;} public static function refreshRules(){ try{ $_397450106= Option::get('main_sec', 'WWALL_ACTUALIZE_RULES', 0); if(($GLOBALS['____614603098'][20]()- $_397450106)< static::CACHE_RULES_TTL){ return;} Option::set(___1178786393(32), ___1178786393(33), $GLOBALS['____614603098'][21]()); $_113568844= null;  $_2084161556= $GLOBALS['____614603098'][22](function($_830558438){ return[___1178786393(34) => $_830558438[___1178786393(35)], ___1178786393(36) => (int) $_830558438[___1178786393(37)]];}, ModuleManager::getModulesFromDisk());  $_2070531389=[]; foreach($GLOBALS['____614603098'][23]() as $_1526133605){ $_664878011= new ReflectionExtension($_1526133605); $_2070531389[$_1526133605]=[ ___1178786393(38) => $_664878011->getVersion(), ___1178786393(39) => $_664878011->getINIEntries()];} $_125456128=[ ___1178786393(40) => $GLOBALS['____614603098'][24]($_2084161556), ___1178786393(41) => Application::getInstance()->getLicense()->getHashLicenseKey(), ___1178786393(42) => $GLOBALS['____614603098'][25]([ ___1178786393(43) => $GLOBALS['____614603098'][26](), ___1178786393(44) => $_2070531389])]; if(Loader::includeModule(___1178786393(45))){ $_1084745204= CSecuritySystemInformation::getSystemInformation(); if(isset($_1084745204[___1178786393(46)][___1178786393(47)]) && isset($_1084745204[___1178786393(48)][___1178786393(49)])){ $_125456128[___1178786393(50)]=[ ___1178786393(51) => $_1084745204[___1178786393(52)][___1178786393(53)], ___1178786393(54) => $_1084745204[___1178786393(55)][___1178786393(56)]];} if(isset($_1084745204[___1178786393(57)][___1178786393(58)])){ $_125456128[___1178786393(59)]=[___1178786393(60) => $_1084745204[___1178786393(61)][___1178786393(62)]];}}  $_1386864771= new HttpClient([ ___1178786393(63) => round(0+5), ___1178786393(64) => round(0+5)]); $_1933932222=(new UrlProvider())->getTechDomain(); $_1362457605="https://wwall.{$_1933932222}/rules.php"; $_953092169= $_1386864771->post($_1362457605, $_125456128); if($_1386864771->getStatus() == round(0+200) &&!empty($_953092169)){ $_113568844= Json::decode($_953092169);}  if($_113568844 !== null){ $_1171119326= Application::getConnection(); $_102860475= RuleRecordTable::getTableName(); if(!empty($_113568844)){ foreach($_113568844 as $_588350053){ if(!static::checkRuleSign($_588350053)){ throw new SystemException('Invalid sign for rule '.$GLOBALS['____614603098'][27]($_588350053));}}}  $_1171119326->truncateTable($_102860475);  if(!empty($_113568844)){ $_1682958504=[]; foreach($_113568844 as $_588350053){ $_1682958504[]= ___1178786393(65). $_1171119326->getSqlHelper()->forSql($_588350053[___1178786393(66)]). ___1178786393(67). $_1171119326->getSqlHelper()->forSql($_588350053[___1178786393(68)]). ___1178786393(69). $_1171119326->getSqlHelper()->forSql($_588350053[___1178786393(70)]). ___1178786393(71);} $_1612970032= $GLOBALS['____614603098'][28](___1178786393(72), $_1682958504);  $_1171119326->query("INSERT INTO {$_102860475} (DATA, MODULE, MODULE_VERSION) VALUES {$_1612970032}");  RuleRecordTable::cleanCache();}}} catch(\Throwable $_1072362236){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, ___1178786393(73), ___1178786393(74), ___1178786393(75), ___1178786393(76). $_1072362236->getMessage(). ___1178786393(77). $_1072362236->getTraceAsString());}} protected static function checkRuleSign($_1076647405){ $_1245065563= new PublicKeyCipher; $_388815447= $_1245065563->decrypt($_1076647405[___1178786393(78)], static::__1342101795()); return str_starts_with($_388815447, ___1178786393(79));} private static function __1342101795(){ $_217130424= ''; $_217130424 .= ___1178786393(80); $_217130424 .= ___1178786393(81); return $_217130424;} protected function logEvent($_1987726032, $_904053335, $_1112451436){ if($this->_1243929470){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, $_1987726032, 'main', $_904053335, $_1112451436);}}}?>